services:
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 1s
      timeout: 3s
      retries: 30
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
    - rabbitmq-data:/var/lib/rabbitmq
  
  publisherservice:
    build:
      context: .
      dockerfile: ./PublisherService/Dockerfile
    ports:
      - "8013:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://0.0.0.0:80
    depends_on:
      rabbitmq:
        condition: service_healthy

  articleservice:
    build:
      context: .
      dockerfile: ./ArticleService/dockerfile
    ports:
      - "8023:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://0.0.0.0:80
    depends_on:
      rabbitmq:
        condition: service_healthy
      articles-africa-db:
              condition: service_started
      articles-asia-db:
              condition: service_started
      articles-antarctica-db:
              condition: service_started
      articles-europe-db:
              condition: service_started
      articles-north-america-db:
              condition: service_started
      articles-south-america-db:
              condition: service_started
      articles-oceania-db:
              condition: service_started
      articles-global-db:
              condition: service_started

  articles-africa-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
        MSSQL_SA_PASSWORD: "SuperSecret7!"
        ACCEPT_EULA: "Y"
    volumes:
        - mssql-africa-articles:/var/opt/mssql
  articles-asia-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - mssql-asia-articles:/var/opt/mssql
  articles-antarctica-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - mssql-antarctica-articles:/var/opt/mssql
  articles-europe-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - mssql-europe-articles:/var/opt/mssql
  articles-north-america-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - mssql-north-america-articles:/var/opt/mssql
  articles-south-america-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - mssql-south-america-articles:/var/opt/mssql
  articles-oceania-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - mssql-oceania-articles:/var/opt/mssql
  articles-global-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    environment:
      MSSQL_SA_PASSWORD: "SuperSecret7!"
      ACCEPT_EULA: "Y"
    volumes:
      - mssql-global-articles:/var/opt/mssql

volumes:
  mssql-africa-articles:
  mssql-asia-articles:
  mssql-antarctica-articles:
  mssql-europe-articles:
  mssql-north-america-articles:
  mssql-south-america-articles:
  mssql-oceania-articles:
  mssql-global-articles:
  rabbitmq-data:  